<!doctype html><html>
  <head>
    <meta charset="UTF-8">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
     canvas {border:1px solid;max-width:50px;}
     </style>
  
  
  

    
  
  
  </head>
  
  
  
  <body style="direction:rtl">

<div style="font-family:title">.</div>
<div style="font-family:text">.</div>

<input id="tag" value="anjelaworld@"/><br>

 <input type="color" id="thumb" name="thumb"
           value="#e66465">
           
           
<div id="canvases" style="width:100%;border:1px solid black;overflow:auto;height:50px">
</div>



<textarea id="title" style="width:100%;height:50px;direction:rtl">
فال روزانه قهوه
دوشنبه ۳۲ اسنفد
</textarea>


<textarea id="txt" style="width:100%;height:250px;direction:rtl">
عنوان یک
امروز صبح تمایل دارید که در ابرها سیر کنید و مشکلات مهم را نادیده بگیرید، مشکلاتی که قرار بود با آنها برخورد کنید. زمان خوبی برای شروع پروژه های جدید نمی باشد زیرا تصمیمات شما بهترین نیست. بهتر است که کمک به بستگان نزدیک را رد نکنید.

عنوان یک
امروز صبح تمایل دارید که در ابرها سیر کنید و مشکلات مهم را نادیده بگیرید، مشکلاتی که قرار بود با آنها برخورد کنید. زمان خوبی برای شروع پروژه های جدید نمی باشد زیرا تصمیمات شما بهترین نیست. بهتر است که کمک به بستگان نزدیک را رد نکنید.

عنوان یک
امروز صبح تمایل دارید که در ابرها سیر کنید و مشکلات مهم را نادیده بگیرید، مشکلاتی که قرار بود با آنها برخورد کنید. زمان خوبی برای شروع پروژه های جدید نمی باشد زیرا تصمیمات شما بهترین نیست. بهتر است که کمک به بستگان نزدیک را رد نکنید.

عنوان یک
امروز صبح تمایل دارید که در ابرها سیر کنید و مشکلات مهم را نادیده بگیرید، مشکلاتی که قرار بود با آنها برخورد کنید. زمان خوبی برای شروع پروژه های جدید نمی باشد زیرا تصمیمات شما بهترین نیست. بهتر است که کمک به بستگان نزدیک را رد نکنید.

عنوان یک
امروز صبح تمایل دارید که در ابرها سیر کنید و مشکلات مهم را نادیده بگیرید، مشکلاتی که قرار بود با آنها برخورد کنید. زمان خوبی برای شروع پروژه های جدید نمی باشد زیرا تصمیمات شما بهترین نیست. بهتر است که کمک به بستگان نزدیک را رد نکنید.

عنوان یک
امروز صبح تمایل دارید که در ابرها سیر کنید و مشکلات مهم را نادیده بگیرید، مشکلاتی که قرار بود با آنها برخورد کنید. زمان خوبی برای شروع پروژه های جدید نمی باشد زیرا تصمیمات شما بهترین نیست. بهتر است که کمک به بستگان نزدیک را رد نکنید.

عنوان یک
امروز صبح تمایل دارید که در ابرها سیر کنید و مشکلات مهم را نادیده بگیرید، مشکلاتی که قرار بود با آنها برخورد کنید. زمان خوبی برای شروع پروژه های جدید نمی باشد زیرا تصمیمات شما بهترین نیست. بهتر است که کمک به بستگان نزدیک را رد نکنید.

عنوان یک
امروز صبح تمایل دارید که در ابرها سیر کنید و مشکلات مهم را نادیده بگیرید، مشکلاتی که قرار بود با آنها برخورد کنید. زمان خوبی برای شروع پروژه های جدید نمی باشد زیرا تصمیمات شما بهترین نیست. بهتر است که کمک به بستگان نزدیک را رد نکنید.

عنوان یک
امروز صبح تمایل دارید که در ابرها سیر کنید و مشکلات مهم را نادیده بگیرید، مشکلاتی که قرار بود با آنها برخورد کنید. زمان خوبی برای شروع پروژه های جدید نمی باشد زیرا تصمیمات شما بهترین نیست. بهتر است که کمک به بستگان نزدیک را رد نکنید.

عنوان یک
امروز صبح تمایل دارید که در ابرها سیر کنید و مشکلات مهم را نادیده بگیرید، مشکلاتی که قرار بود با آنها برخورد کنید. زمان خوبی برای شروع پروژه های جدید نمی باشد زیرا تصمیمات شما بهترین نیست. بهتر است که کمک به بستگان نزدیک را رد نکنید.

عنوان یک
امروز صبح تمایل دارید که در ابرها سیر کنید و مشکلات مهم را نادیده بگیرید، مشکلاتی که قرار بود با آنها برخورد کنید. زمان خوبی برای شروع پروژه های جدید نمی باشد زیرا تصمیمات شما بهترین نیست. بهتر است که کمک به بستگان نزدیک را رد نکنید.

عنوان یک
امروز صبح تمایل دارید که در ابرها سیر کنید و مشکلات مهم را نادیده بگیرید، مشکلاتی که قرار بود با آنها برخورد کنید. زمان خوبی برای شروع پروژه های جدید نمی باشد زیرا تصمیمات شما بهترین نیست. بهتر است که کمک به بستگان نزدیک را رد نکنید.


</textarea>


<br>

<input id="music" value="music.mp3"/>
<br>
<input id="cover" value="cover.mp4"/>

<br>
<input id="titlefont" value="title.ttf"/>
<br>
<input id="textfont" value="text.ttf"/>
<br>
<input id="musicstart" value="5"/>
<br>
<input id="size" value="1080"/>
<br>
<script>

function loadfonttodom(name,font) {

  $("style[data-name='"+name+"']").remove();
  
  

$("head").prepend("<style data-name=\""+name+"\" type=\"text/css\">" + 
                                "@font-face {\n" +
                                    "\tfont-family: \""+name+"\";\n" + 
                                    "\tsrc: url('"+font+"') format('truetype');\n" + 
                                "}\n"+"</style>");
                            
                            
                            
}


$("#titlefont").on('change keyup',function() {
 loadfonttodom("title",$(this).val());
});

$("#textfont").on('change keyup',function() {
 loadfonttodom("text",$(this).val());
});

$(document).ready(function() {

 loadfonttodom("title",$("#titlefont").val());
 loadfonttodom("text",$("#textfont").val());
});


$("#size").on('change keyup',function() {
 w = parseInt($(this).val());
});
</script>


<br>
<button id="gen">
  gen
</button>
<script>
 w = 1080;
CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
  if (w < 2 * r) r = w / 2;
  if (h < 2 * r) r = h / 2;
  this.beginPath();
  this.moveTo(x+r, y);
  this.arcTo(x+w, y,   x+w, y+h, r);
  this.arcTo(x+w, y+h, x,   y+h, r);
  this.arcTo(x,   y+h, x,   y,   r);
  this.arcTo(x,   y,   x+w, y,   r);
  this.closePath();
  return this;
}


 function txt_height(ctx, txt) {
        let metrics = ctx.measureText(txt);
        let fontHeight =
          metrics.fontBoundingBoxAscent + metrics.fontBoundingBoxDescent;
        return (actualHeight =
          metrics.actualBoundingBoxAscent + metrics.actualBoundingBoxDescent);
      }

      function maketxt(ctx,txt,cap,beginY=0) {
        ctx.font = w * 0.06 + 'px text';
        ctx.textAlign = 'left';
        
        var ypos = beginY+txt_height(ctx, txt) /*+ w * d1;*/
        ctx.fillText(txt, w - w * d1 - ctx.measureText(txt).width, ypos);

          cap = cap.replace(/\s\s+/g, ' ');

        

       // ctx.font = w * d2 + 'px text';
        
      //  console.log();
        
          var fsiz = Math.pow(0.9 , cap.length*0.1)*w/2.97;
          
          if (fsiz >= w/29) {
           fsiz = w/29
          }
          

          
          ctx.font = fsiz + 'px text';
          

        ypos += txt_height(ctx, txt) + w * d1
        
        var llx =  linebreak(
          cap,
          maxw,
          ctx
        );
       llx.forEach(function (line,i) {
          ctx.textAlign = 'left';
          ctx.fillText(
            line,
            w - w * d1 - ctx.measureText(line).width,
            ypos
          );
          if (i+1 != llx.length) {
          ypos += txt_height(ctx, line)+w*0.01;
          } else {
          ypos += w*0.02;
          }
        });

        return ypos;
      }

      linebreak = function (txt, maxwidthx, ctx) {
        var splited = txt.split(' ');

        var lines = [];

        var thisline = '';
        splited.forEach(function (itm) {
          var widthx = ctx.measureText(thisline).width;

          if (widthx < maxwidthx) {
            thisline = thisline + ' ' + itm;
          } else {
            thisline = thisline + ' ' + itm;
            lines.push(thisline.trim());
            thisline = '';
          }
        });

        lines.push(thisline.trim());
        return lines;
      };

      function faal(txts) {
        var x = $(
          '<canvas width="400" height="400" style="direction:rtl"></canvas>'
        );
        var ctx = x[0].getContext('2d');

        
         
         x[0].width = w;
         x[0].height = w;
         
         d0 = 0.01;
         d1 = 0.03;
         d2 = 0.04;

        ctx.globalAlpha = 0.7;
        ctx.fillStyle = "#FFFFFF";
        ctx.roundRect(w*d0, w*d0, w-(w*d0)*2, w-(w*d0)*2, 20).fill(); 
        ctx.fillStyle = "#000000";
        ctx.globalAlpha = 1;

         maxw = w - +w * (d1 * 9.5);

         var yposs = 0;
         
         

      


setTimeout(()=>{

       txts.forEach(function (fall) {
       
                 yposs = maketxt(ctx,fall.title,fall.text,yposs);
       });

},100);


        return x;
      }
      
      
      
 
 function makecover() {

var x = $('<canvas width="100" height="100" style="direction:rtl"></canvas>');
var ctx = x[0].getContext('2d');
setTimeout(()=>{
         
          ctx.textAlign = "left";



         x[0].width = w;
         x[0].height = w;
         

          var txt = $("#title").val().trim()+"\n";
         
         
         
      //  ctx.font = w * 0.15 + 'px title';
       
       
       var fsiz2 = Math.pow(0.9 , txt.trim().length*0.1)*w/2.97;
           if (fsiz2 >= w/6) {
           fsiz2= w/6
          }
          
          
       
         ctx.font = fsiz2 + 'px title';


        ctx.globalAlpha = 0.7;
        ctx.fillStyle = $("#thumb").val();
        var th = 0;
      
        txt.split("\n").forEach(function(l) {        
          l = l.trim();
          th += txt_height(ctx, l)+w*0.05;
        });
  
      
      //  var txtheight = txt_height(ctx, txt);


        var ypos = w-th;

     
       ctx.fillRect(0, ypos-txt_height(ctx, txt)-w*0.025, w,th+w*0.025); 

        ctx.fillStyle = "#000000";
        ctx.globalAlpha = 1;

		ctx.strokeStyle = '#FFFFFF';
		ctx.lineWidth = w*0.05;

        txt.split("\n").forEach(function(l) {
        
        
          
          l = l.trim();
          
          /**/
          fsiz2 = Math.pow(0.9 , l.trim().length*0.35)*w/4;
          
                    console.log(l+" is"+fsiz2);
                    
                    
          if (fsiz2 >= w/3) {
          // fsiz2= w/3
          }
          

       
         ctx.font = fsiz2 + 'px title';
          /**/
          
           ctx.strokeText(l, (w+ctx.measureText(l).width)/2, ypos );
           ctx.fillText(l, (w+ctx.measureText(l).width)/2, ypos );
          
          ypos += txt_height(ctx, l)+w*0.05;
         

        });
        
        
        
        ctx.font = fsiz2*0.55 + 'px title';
        
        
         ctx.fillStyle = "#FFFFFF";
         
          ctx.textAlign = "right";
         ctx.fillText($("#tag").val().trim(), (w+ctx.measureText($("#tag").val().trim()).width)/2, ypos );
        
        
        
        
     },100);  



       return x;
      }     
</script>
<script>



function gen() {

const regexpSize = /^(.*?)\n(.*?)(\n\n)/gms;
var x = $("#txt").val().trim();
x = x+"\n\n"
const match = x.match(regexpSize);
var c = 0;
var fal3 = [];
var allfalls = [];
match.forEach(function(i) {
c++;


var fallitem = i.trim().split("\n"); 

var ttile = fallitem[0].trim();
var ttxt = "";
fallitem.forEach(function(t,i) {
if (i > 0 ) {
ttxt += t+" ";
}
});


fal3.push({"title":ttile,"text":ttxt.trim()+""});

if (c%3>0) {

} else {

if (fal3.length > 0) { 

}
allfalls.push(fal3);
fal3 = [];


}



/*var ffla = faal([
  
  {"title":Math.random()+"","text":Math.random()+""},
  {"title":Math.random()+"","text":Math.random()+""},
  {"title":Math.random()+"","text":Math.random()+""}
  
  ]);
*/
//ffla.attr("data-length","14.5");
  
//$('#canvases').append(ffla);
  

}) ;
if (fal3.length > 0) {
allfalls.push(fal3);
}


allfalls.forEach(function(ff) {
var ffla = faal(ff);

ffla.attr("data-length","14.5");
  
$('#canvases').append(ffla);
}) ;


setTimeout(()=>{

run();

},1000);

}

adsc


$("#gen").click(function() {
$('#canvases').empty();
var zz = makecover();
  zz.attr("data-length","1");
 $('#canvases').append(zz);

gen();

  
 
  
  
});




function run() {
var cmdx = "del out.mp4\n";
cmdx += 'xffmpeg ';

mainwidth = w;
var from = 0;
var to = 0;
var tot = 0;
var fcomplx  = "[1:v]loop=-1:10000:0[cov0];[cov0]scale="+mainwidth+":-1[cover];[0:v][cover]overlay=(main_w-overlay_w)/2:(main_h-overlay_h)/2:shortest=1[mainlayer];" ;
 $("canvas").each(function(itm) {
    var layerlength = parseFloat($(this).attr("data-length"));
    
    tot = tot+layerlength;
    
  //  itm = itm+2;
    to = to+layerlength;
    
    if (itm === 0) {
     var mainlayer = '[mainlayer]';
    } else {
     var mainlayer = '[layer'+(itm-1)+']';
    }
    
   
    if (itm != $("canvas").length-1) {
    var layername = '[layer'+itm+'];';
    } else {
    var layername = "[finalout]";
    }
    
    fcomplx += mainlayer+'['+(itm+2)+':v]overlay=0:0:enable=\'between(t,'+from+','+to+')\''+layername; 
    from = to;
    
    
    
 });
 
 
cmdx += '-t '+tot+' -f lavfi -i color=c=white:s='+mainwidth+'x'+mainwidth+' '
cmdx += '-i '+$("#cover").val()+' '
cmdx += "-i "+[...Array($("canvas").length).keys()].join(".png -i ")+".png ";
cmdx += '-filter_complex "';

//cmdx += '[1:a]atrim=5:900,asetpts=PTS-STARTPTS[moozik];';
 
 cmdx += fcomplx+'" ';
 
 cmdx += '-i music.mp3 -af "atrim='+$("#musicstart").val()+',asetpts=PTS-STARTPTS" '
 
 //cmdx += " -i "+$("#music").val()+" -ss "+$("#musicstart").val()+" -map 0:v -map "+($("canvas").length+2)+":a -shortest ";
 cmdx += " -map [finalout] -shortest  -map "+($("canvas").length+2)+":a out.mp4 -y";


  $("canvas").each(function(itm) {


  var dt = $(this)[0].toDataURL();
$.ajax({

  type: "POST",
                        url: "gen/"+itm,
                        data: dt,
                        success:function() {
                              if (itm+1===$("canvas").length) {
                               cmd(cmdx);
                              }
                        }

});
  
  });
}

function cmd(cmdv) {
$.ajax({

  type: "POST",
                        url: "cmd",
                        data: cmdv,
                        success:function() {
                             
                        }

});
}

</script>
    
  </body>
</html>
